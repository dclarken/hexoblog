---
title: BGP的工作原理
date: 2017-9-12 11:30:21
tags: [笔记,网络协议,bgp]
categories: [笔记,网络协议]
---
![BGP](https://i.loli.net/2017/10/20/59e999adbe5e3.png)

在我们使用AWS提供的硬件VPN服务时，可以使用静态和动态的方式构建隧道。
静态的是指事先知道对方的公网IP，在两个IP之间写好静态的路由，构建一条加密的隧道
动态是指使用BGP协议来自动学习路由。

**`BGP(Border Gateway Protocol)`**  
边界网关协议，TCP 179
BGP是一种在自治系统（AS）之间动态交换路由信息的路由协议。一个自治系统的经典定义是在一个管理机构控制之下的一组路由器，它使用IGP和普通度量值向其他自治系统转发报文。
在BGP中使用自治系统这个术语是为了强调这样一个事实：一个自治系统的管理对于其他自治系统而言是提供一个统一的内部选路计划，它为那些通过它可以到达的网络提供了一个一致的描述。BGP,边界网关协议，是自主网络系统中网关之间交换器路由信息的协议。边界网关协议常常应用于互联网的网关之间。路由表包含已知路由器的列表、路由器能够达到的地址以及到达每个路由器的路径的跳数。
**`BGP报文的四种类型：`**

* 报文Open：打招呼“你好，跟我交个朋友吧！”
* KeepAlive：我还活着呢，别不理我
* Update：有新闻......
* Notification：我不跟你玩了!

BGP协议中消息的应用
通过TCP建立BGP连接时，发送open消息
连接建立后，如果有路由需要发送或路由变化时，发送UPDATE消息通告对端路由信息
稳定后此时要定时发送KEEPALIVE消息（60s）以保持BGP连接的有效性
当本地BGP在运行中发现错误时，要发送NOTIFICATION消息通告BGP对端

**`BGP择路的13个规则`**

* 忽略下一跳不可达的路由
* 忽略不同步的IBGP路由
* 首选具有最大权重优先，思科私有。(local to router)
* 首选具有最大本地优先级优先。(global within AS)
* 首选具有始发本地的路由的路由器优先，(next hop=0.0.0.0)
* 首选具有最短AS-PATH的路由。
* 首选具有最小的源码的路由，IGP〈EBP〈incomplete
* 当所有路由的AS号都相同的时候，首选MED最低的路由，在所有AS号码相同的时候比较MED
* 首选具有EBGP〉联盟EBGP>IBGP
* 首选具有最近的IGP邻居路由器优先，metric
* 首选具有最老的路由优先（注意：现在这条基本不用）
* 首选具有最低ROUTER-ID的路由。(2个BGP地址不能建邻)
* 首选具有最低的neighbor的IP地址